var express = require('express');
var router = express.Router();
var crypto = require('crypto');
var Tx = require('ethereumjs-tx').Transaction;
/* GET home page. */
/*
router.get('/', function (req, res, next) {
    if (!req.session.user_id) {
        res.redirect('/login')
    } else {
        //
        res.render('invest/margin_transaction/directly_use_credit', {
            session: req.session.user_id,
            user: req.session.user_id,
            address: req.session.user_wallet_address
        });
    }
});
*/
var Web3 = require('web3');
const web3 = new Web3();
web3.setProvider(new web3.providers.HttpProvider("https://rinkeby.infura.io/v3/80ddce42db94463ba6d6427f04451f35"));
//margin_credit
var creditAddress = "0x8c51c69a6bc5d4836da8433ceefdc80e7e60ddd7";
var margin2ABI = require('../../margin2ABI');
var margin2ABI = margin2ABI.margin2ABI;
var creditcontract = web3.eth.contract(margin2ABI).at(creditAddress);

//matching
var matchingAddress = "0x33DA8C77ea7744eFcd6F00e11aD170e313401Fc5";
var matchingABI = require('../../matchingABI');
var matchingABI = matchingABI.matchingABI;
var matchingcontract = web3.eth.contract(matchingABI).at(matchingAddress);

var platform = "0x4192a918653Ba6CCF27d4956F8bb60943278e88B";
var platform2 = "0xe1d739f2A154aA0cEcE4dD78e32bAc9F3F485C57";
const { settings } = require('../../../app');
router.get('/', function (req, res) {
    var pool = req.connection;
    pool.getConnection(function (err, connection) {
        connection.query('SELECT * FROM credit_list WHERE borrower_id=? ORDER BY created_time DESC ',[req.session.user_id], function (err, rows) {
            if (err) {
                res.render('error', {
                    message: err.message,
                    error: err
                });

            } else {
                console.log(req.session.user_id)
                console.log(rows[0]);
                var creditID = rows[0].creditID;
                req.session.creditID=creditID;
                var use_amount = rows[0].avail_amount_init;
                req.session.use_amount=use_amount;
                var strategyID = rows[0].strategyID;
                req.session.strategyID=strategyID;
                var buy_amount=rows[0].buy_amount;
                req.session.buy_amount=buy_amount;
                var buy_price=rows[0].buy_price;
                req.session.buy_price=buy_price
                res.render('invest/margin_transaction/directly_use_credit', {
                    session: req.session.user_id,
                    creditID: creditID,
                    use_amount: use_amount,
                    strategyID: strategyID,
                    user_id: req.session.user_id,
                    address: req.session.user_wallet_address,
                })
            }
        });
        connection.release()
    })
})
//directly use margin-credit
router.post('/', function (req, res) {
    var credit_ID = req.session.creditID;
    console.log('credid is:', credit_ID)
    var use_amount = req.session.use_amount;
    var strategy_ID = req.session.strategyID;
    var repay_rate = req.body['repay_rate'];
    if (repay_rate == 3) {
        var rate = 3;
    }
    else if (repay_rate == 6) {
        var rate = 6;
    }
    else {
        var rate = 12;
    }
    var walletaddress = req.session.user_wallet_address;
    //
    var pay_data = creditcontract.approve_and_transfer.getData(walletaddress, platform, use_amount, { from: platform });
    var pay_count = web3.eth.getTransactionCount(platform);
    var gasPrice_pay = web3.toWei(20, 'gwei')
    var gasLimit_pay = 8000000;
    var pay_rawTrans = {
        "from": platform,
        "nonce": web3.toHex(pay_count),
        "gasPrice": web3.toHex(gasPrice_pay),
        "gasLimit": web3.toHex(gasLimit_pay),
        "to": creditAddress,
        "value": "0x0",
        "data": pay_data,
        "chainId": 0x04
    };
    var platform_privKey = Buffer.from("a9497f7a63cbce8f9449608dc31c635787f8cc0869f064b3748375bcdeca907e", "hex");//platform
    var pay_tx = new Tx(pay_rawTrans, { chain: 'rinkeby' });
    pay_tx.sign(platform_privKey);
    var serializedTx_pay = pay_tx.serialize();
    var txhash = web3.eth.sendRawTransaction('0x' + serializedTx_pay.toString('hex'));
    console.log("pay_hash:", txhash)
    //pay credit record
    setTimeout(function () {
        var record_data = creditcontract.pay_credit.getData(walletaddress, credit_ID, use_amount, { from: platform });
        var record_count = pay_count+1;
        var gasPrice_record = web3.toWei(20, 'gwei')
        var gasLimit_record = 8000000;
        var record_rawTrans = {
            "from": platform,
            "nonce": web3.toHex(record_count),
            "gasPrice": web3.toHex(gasPrice_record),
            "gasLimit": web3.toHex(gasLimit_record),
            "to": creditAddress,
            "value": "0x0",
            "data": record_data,
            "chainId": 0x04
        };
        var platform_privKey = Buffer.from("a9497f7a63cbce8f9449608dc31c635787f8cc0869f064b3748375bcdeca907e", "hex");//platform
        var record_tx = new Tx(record_rawTrans, { chain: 'rinkeby' });
        record_tx.sign(platform_privKey);
        var serializedTx_record = record_tx.serialize();
        var txhash2 = web3.eth.sendRawTransaction('0x' + serializedTx_record.toString('hex'));
        console.log("pay_record_hash:", txhash2)

    }, 30000)
    var randbytes = ('0x' + crypto.randomBytes(8).toString('hex'));
    var match_data = matchingcontract.make_funding_requirement.getData(walletaddress, use_amount, credit_ID, randbytes, rate, { from: platform2 });
    var match_count = web3.eth.getTransactionCount(platform2);
    var gasPrice_match = web3.toWei(20, 'gwei')
    var gasLimit_match = 8000000;
    var match_rawTrans = {
        "from": platform2,
        "nonce": web3.toHex(match_count),
        "gasPrice": web3.toHex(gasPrice_match),
        "gasLimit": web3.toHex(gasLimit_match),
        "to": matchingAddress,
        "value": "0x0",
        "data": match_data,
        "chainId": 0x04
    };
    var match_tx = new Tx(match_rawTrans, { chain: 'rinkeby' });
    var platform2_privKey = Buffer.from("2c80810afdeec70c48dec6bf412e0ba78de5dad18d54c7f7367af103fb755c0e", "hex");//platform2
    match_tx.sign(platform2_privKey);
    var serializedTx_match = match_tx.serialize();
    var match_txhash = web3.eth.sendRawTransaction('0x' + serializedTx_match.toString('hex'));
    console.log("match_hash:", match_txhash)
    setTimeout(function () {
        var requirement_len = matchingcontract.requirement_length.call().toNumber();
        console.log(requirement_len)
        var requirementID = matchingcontract.get_requirement_id.call(requirement_len - 1);
        console.log('requirementID:', requirementID)
       
        //deploy tranche contract
    },30000);
        
        var bytecode = 
           "60806040527363a40281087c53479382283de03d64a83f5c7df0601460006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055503480156200006657600080fd5b5060405160808062006e548339810180604052620000889190810190620001ee565b33600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600060018190555082600c819055508160088190555080600e8190555083600960006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600e5460076000600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000600c5481526020019081526020016000208190555050505050620002a2565b6000620001ba82516200027a565b905092915050565b6000620001d082516200028e565b905092915050565b6000620001e6825162000298565b905092915050565b600080600080608085870312156200020557600080fd5b60006200021587828801620001ac565b94505060206200022887828801620001c2565b93505060406200023b87828801620001d8565b92505060606200024e87828801620001d8565b91505092959194509250565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b600062000287826200025a565b9050919050565b6000819050919050565b6000819050919050565b616ba280620002b26000396000f3fe608060405260043610610277576000357c01000000000000000000000000000000000000000000000000000000009004806304100ecc1461027c57806306fdde03146102b9578063095ea7b3146102e4578063099f060014610321578063104e81ff1461035e5780631296830d1461039b57806318160ddd146103d857806319045a25146104035780631ca73720146104405780631fdc90641461047d57806323b872dd146104ba57806326004ab0146104f757806326400a89146105225780632d0335ab1461055f578063313ce5671461059c57806335f00a11146105c757806346d78c3f146105f257806347eec3fe1461061d578063617b390b1461065a57806366188463146106975780636735e60b146106d4578063698518e5146107115780636a256b291461073c57806370a08231146107655780637a81236e146107a25780637bc14a67146107cd57806384ba745e146107f85780638be52783146108235780638da5cb5b1461086057806395d89b411461088b57806397880699146108b657806399bbc437146108f35780639a108140146109305780639d257b4e1461096d5780639e8054ba14610998578063a4fe1330146109d5578063a6c5e2d414610a14578063a9059cbb14610a51578063adb8249e14610a8e578063aef8c43414610acb578063c26cb54f14610b08578063c5bbe92e14610b47578063c6f7b7eb14610b72578063c814ffc614610bb0578063ce4b8a3214610bed578063d73dd62314610c2a578063dd62ed3e14610c67578063e902469114610ca4578063f021965014610ce1578063f05aef0214610d1e578063f2fde38b14610d5b578063f68530d414610d84578063fb04ce0614610daf575b600080fd5b34801561028857600080fd5b506102a3600480360361029e919081019061617a565b610dda565b6040516102b09190616928565b60405180910390f35b3480156102c557600080fd5b506102ce610e3a565b6040516102db9190616864565b60405180910390f35b3480156102f057600080fd5b5061030b6004803603610306919081019061617a565b610e73565b604051610318919061682e565b60405180910390f35b34801561032d57600080fd5b5061034860048036036103439190810190616066565b610f65565b604051610355919061682e565b60405180910390f35b34801561036a57600080fd5b5061038560048036036103809190810190616066565b610f86565b604051610392919061682e565b60405180910390f35b3480156103a757600080fd5b506103c260048036036103bd9190810190616382565b61115c565b6040516103cf919061682e565b60405180910390f35b3480156103e457600080fd5b506103ed61174c565b6040516103fa9190616928565b60405180910390f35b34801561040f57600080fd5b5061042a6004803603610425919081019061632e565b611756565b60405161043791906166eb565b60405180910390f35b34801561044c57600080fd5b506104676004803603610462919081019061617a565b61183a565b6040516104749190616928565b60405180910390f35b34801561048957600080fd5b506104a4600480360361049f919081019061617a565b61189a565b6040516104b19190616849565b60405180910390f35b3480156104c657600080fd5b506104e160048036036104dc9190810190616066565b6118bf565b6040516104ee919061682e565b60405180910390f35b34801561050357600080fd5b5061050c611c79565b6040516105199190616928565b60405180910390f35b34801561052e57600080fd5b50610549600480360361054491908101906160b5565b611cfa565b6040516105569190616928565b60405180910390f35b34801561056b57600080fd5b5061058660048036036105819190810190616001565b611d1f565b6040516105939190616928565b60405180910390f35b3480156105a857600080fd5b506105b1611d68565b6040516105be91906169a3565b60405180910390f35b3480156105d357600080fd5b506105dc611d6d565b6040516105e99190616928565b60405180910390f35b3480156105fe57600080fd5b50610607611d7a565b604051610614919061680c565b60405180910390f35b34801561062957600080fd5b50610644600480360361063f9190810190616066565b611df8565b604051610651919061682e565b60405180910390f35b34801561066657600080fd5b50610681600480360361067c9190810190616382565b611e18565b60405161068e919061682e565b60405180910390f35b3480156106a357600080fd5b506106be60048036036106b9919081019061617a565b6123e4565b6040516106cb919061682e565b60405180910390f35b3480156106e057600080fd5b506106fb60048036036106f691908101906161b6565b612675565b6040516107089190616928565b60405180910390f35b34801561071d57600080fd5b506107266126a7565b6040516107339190616928565b60405180910390f35b34801561074857600080fd5b50610763600480360361075e9190810190616001565b6126ac565b005b34801561077157600080fd5b5061078c60048036036107879190810190616001565b612e7d565b6040516107999190616928565b60405180910390f35b3480156107ae57600080fd5b506107b7612ec5565b6040516107c49190616928565b60405180910390f35b3480156107d957600080fd5b506107e2612ecb565b6040516107ef9190616928565b60405180910390f35b34801561080457600080fd5b5061080d612ed0565b60405161081a9190616928565b60405180910390f35b34801561082f57600080fd5b5061084a60048036036108459190810190616382565b612eda565b604051610857919061682e565b60405180910390f35b34801561086c57600080fd5b50610875613634565b60405161088291906166eb565b60405180910390f35b34801561089757600080fd5b506108a061365a565b6040516108ad9190616864565b60405180910390f35b3480156108c257600080fd5b506108dd60048036036108d89190810190616205565b613693565b6040516108ea919061682e565b60405180910390f35b3480156108ff57600080fd5b5061091a60048036036109159190810190616205565b613aa2565b604051610927919061682e565b60405180910390f35b34801561093c57600080fd5b506109576004803603610952919081019061617a565b613ccf565b6040516109649190616928565b60405180910390f35b34801561097957600080fd5b50610982613d32565b60405161098f9190616928565b60405180910390f35b3480156109a457600080fd5b506109bf60048036036109ba9190810190616205565b613d37565b6040516109cc919061682e565b60405180910390f35b3480156109e157600080fd5b506109fc60048036036109f79190810190616411565b6142ff565b604051610a0b9392919061696c565b60405180910390f35b348015610a2057600080fd5b50610a3b6004803603610a36919081019061617a565b614338565b604051610a489190616928565b60405180910390f35b348015610a5d57600080fd5b50610a786004803603610a73919081019061617a565b61435d565b604051610a85919061682e565b60405180910390f35b348015610a9a57600080fd5b50610ab56004803603610ab09190810190616382565b61457c565b604051610ac2919061682e565b60405180910390f35b348015610ad757600080fd5b50610af26004803603610aed919081019061617a565b614d5c565b604051610aff9190616928565b60405180910390f35b348015610b1457600080fd5b50610b2f6004803603610b2a919081019061617a565b614d81565b604051610b3e9392919061696c565b60405180910390f35b348015610b5357600080fd5b50610b5c614db8565b604051610b699190616928565b60405180910390f35b348015610b7e57600080fd5b50610b996004803603610b949190810190616411565b614dc7565b604051610ba792919061674b565b60405180910390f35b348015610bbc57600080fd5b50610bd76004803603610bd2919081019061617a565b614e1a565b604051610be49190616928565b60405180910390f35b348015610bf957600080fd5b50610c146004803603610c0f9190810190616254565b614e3f565b604051610c21919061682e565b60405180910390f35b348015610c3657600080fd5b50610c516004803603610c4c919081019061617a565b615089565b604051610c5e919061682e565b60405180910390f35b348015610c7357600080fd5b50610c8e6004803603610c89919081019061602a565b615285565b604051610c9b9190616928565b60405180910390f35b348015610cb057600080fd5b50610ccb6004803603610cc691908101906160f1565b61530c565b604051610cd89190616849565b60405180910390f35b348015610ced57600080fd5b50610d086004803603610d0391908101906162b7565b61541d565b604051610d15919061682e565b60405180910390f35b348015610d2a57600080fd5b50610d456004803603610d40919081019061617a565b615ab0565b604051610d529190616928565b60405180910390f35b348015610d6757600080fd5b50610d826004803603610d7d9190810190616001565b615b13565b005b348015610d9057600080fd5b50610d99615c66565b604051610da69190616928565b60405180910390f35b348015610dbb57600080fd5b50610dc4615c6c565b604051610dd19190616849565b60405180910390f35b600080601060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008481526020019081526020016000205490508091505092915050565b6040805190810160405280600781526020017f5472616e6368650000000000000000000000000000000000000000000000000081525081565b600081600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92584604051610f539190616928565b60405180910390a36001905092915050565b6000610f72848484610f86565b50610f7e8484846118bf565b509392505050565b60008073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1614151515610ff9576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ff090616908565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415151561106b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611062906168a8565b60405180910390fd5b81600260008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516111499190616928565b60405180910390a3600190509392505050565b60008073ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff161415151561119957600080fd5b600015156004876040518082805190602001908083835b6020831015156111d557805182526020820191506020810190506020830392506111b0565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060009054906101000a900460ff16151514151561122457600080fd5b6000611257306348664c167c0100000000000000000000000000000000000000000000000000000000028888888861530c565b905060006112658289611756565b9050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16141515156112a357600080fd5b6112f66001600560008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b8414151561130357600080fd5b6000808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546113558688615c7290919063ffffffff16565b1115151561136257600080fd5b83600560008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555060016004896040518082805190602001908083835b6020831015156113e057805182526020820191506020810190506020830392506113bb565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff02191690831515021790555061148d8561147f886000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615cc990919063ffffffff16565b615cc990919063ffffffff16565b6000808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550611520866000808a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b6000808973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506115b3856000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508673ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef886040516116529190616928565b60405180910390a33373ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f113d3b6b59ede2f839043974b893b9629224d06afc4b0ba37d71975a5fb5c361876040516116b79190616928565b60405180910390a33373ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167fec5a73fd1f178be20c1bca1b406cbf4b5c20d833b66e582fc122fb4baa0fc2a48989604051611735929190616943565b60405180910390a460019250505095945050505050565b6000600154905090565b600080600080604185511415156117735760009350505050611834565b6020850151925060408501519150606085015160001a9050601b8160ff16101561179e57601b810190505b601b8160ff16141580156117b65750601c8160ff1614155b156117c75760009350505050611834565b60018682858560405160008152602001604052604051808581526020018460ff1660ff1681526020018381526020018281526020019450505050506020604051602081039080840390855afa158015611824573d6000803e3d6000fd5b5050506020604051035193505050505b92915050565b600080600660008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008481526020019081526020016000205490508091505092915050565b6012602052816000526040600020602052806000526040600020600091509150505481565b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16141515156118fc57600080fd5b6000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054821115151561194957600080fd5b600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205482111515156119d457600080fd5b611a25826000808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615cc990919063ffffffff16565b6000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550611ab8826000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b6000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550611b8982600260008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615cc990919063ffffffff16565b600260008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef84604051611c669190616928565b60405180910390a3600190509392505050565b60008060076000600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000600c5481526020019081526020016000205490508091505090565b6007602052816000526040600020602052806000526040600020600091509150505481565b6000600560008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b600081565b6000600a80549050905090565b6060600a805480602002602001604051908101604052809291908181526020016000905b82821015611def578382906000526020600020906003020160606040519081016040529081600082015481526020016001820154815260200160028201548152505081526020019060010190611d9e565b50505050905090565b6000611e048483610e73565b50611e108484846118bf565b509392505050565b60008073ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff1614151515611e5557600080fd5b600015156004876040518082805190602001908083835b602083101515611e915780518252602082019150602081019050602083039250611e6c565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060009054906101000a900460ff161515141515611ee057600080fd5b6000611f133063f7ac9c2e7c0100000000000000000000000000000000000000000000000000000000028888888861530c565b90506000611f218289611756565b9050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1614151515611f5f57600080fd5b611fb26001600560008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b84141515611fbf57600080fd5b6000808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546120118688615c7290919063ffffffff16565b1115151561201e57600080fd5b83600560008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555060016004896040518082805190602001908083835b60208310151561209c5780518252602082019150602081019050602083039250612077565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff02191690831515021790555085600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506121b8856000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615cc990919063ffffffff16565b6000808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555061224b856000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508673ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925886040516122ea9190616928565b60405180910390a33373ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8760405161234f9190616928565b60405180910390a33373ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f43a220267705e74ee2ceafd46afc841850db6f85a662189a7def697bbdd90ffb89896040516123cd929190616943565b60405180910390a460019250505095945050505050565b600080600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050808311156124f5576000600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550612589565b6125088382615cc990919063ffffffff16565b600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055505b8373ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546040516126629190616928565b60405180910390a3600191505092915050565b601360205282600052604060002060205281600052604060002060205280600052604060002060009250925050505481565b600181565b6000600a8054905014156126f557600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16ff5b60008090505b600b80549050811015612e795761284960066000600b8481548110151561271e57fe5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000600b8481548110151561279b57fe5b906000526020600020906002020160010154815260200190815260200160002054600080600b858154811015156127ce57fe5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615cc990919063ffffffff16565b600080600b8481548110151561285b57fe5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555060006001600a805490500390505b600081111515612e6b57600a818154811015156128f257fe5b90600052602060002090600302016000808201600090556001820160009055600282016000905550506060600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16601460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16600b8581548110151561297257fe5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1660066000600b888154811015156129b757fe5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000600b88815481101515612a3457fe5b906000526020600020906002020160010154815260200190815260200160002054604051602401612a689493929190616706565b6040516020818303038152906040527fabf9c1db000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505090508373ffffffffffffffffffffffffffffffffffffffff16816040518082805190602001908083835b602083101515612b345780518252602082019150602081019050602083039250612b0f565b6001836020036101000a0380198251168184511680821785525050505050509050019150506000604051808303816000865af19150503d8060008114612b96576040519150601f19603f3d011682016040523d82523d6000602084013e612b9b565b606091505b505050600073ffffffffffffffffffffffffffffffffffffffff16600b84815481101515612bc557fe5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60066000600b88815481101515612c4157fe5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000600b88815481101515612cbe57fe5b906000526020600020906002020160010154815260200190815260200160002054604051612cec9190616928565b60405180910390a360116000600b85815481101515612d0757fe5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000600b85815481101515612d8457fe5b90600052602060002090600202016001015481526020019081526020016000206000905560106000600b85815481101515612dbb57fe5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000600b85815481101515612e3857fe5b906000526020600020906002020160010154815260200190815260200160002060009055508080600190039150506128d9565b5080806001019150506126fb565b5050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b600e5481565b600081565b6000600854905090565b60008073ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff1614151515612f1757600080fd5b600015156004876040518082805190602001908083835b602083101515612f535780518252602082019150602081019050602083039250612f2e565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060009054906101000a900460ff161515141515612fa257600080fd5b6000612fd5306359388d787c0100000000000000000000000000000000000000000000000000000000028888888861530c565b90506000612fe38289611756565b9050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415151561302157600080fd5b6130746001600560008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b8414151561308157600080fd5b6000808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205485111515156130ce57600080fd5b83600560008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555060016004896040518082805190602001908083835b60208310151561314c5780518252602082019150602081019050602083039250613127565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff0219169083151502179055506000600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050808711156132a6576000600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555061333a565b6132b98782615cc990919063ffffffff16565b600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055505b61338b866000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615cc990919063ffffffff16565b6000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555061341e866000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508773ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925896040516134bd9190616928565b60405180910390a33373ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef886040516135229190616928565b60405180910390a33373ffffffffffffffffffffffffffffffffffffffff168873ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f43a220267705e74ee2ceafd46afc841850db6f85a662189a7def697bbdd90ffb600260008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008d73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020548a60405161361c929190616943565b60405180910390a46001935050505095945050505050565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b6040805190810160405280600781526020017f7472616e6368650000000000000000000000000000000000000000000000000081525081565b60008260085481111515156136a757600080fd5b6000811115156136b657600080fd5b600660008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600085815260200190815260200160002054831115151561371557600080fd5b61377883600660008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600087815260200190815260200160002054615cc990919063ffffffff16565b600660008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000868152602001908152602001600020819055506137f985601460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1685610f65565b5061384b836000808873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615cc990919063ffffffff16565b6000808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555061390083600080601460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b600080601460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506139da83601360008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008781526020019081526020016000206000600c54815260200190815260200160002054615c7290919063ffffffff16565b601360008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008681526020019081526020016000206000600c54815260200190815260200160002081905550600c548573ffffffffffffffffffffffffffffffffffffffff167fd4a162c374072910f5390c5358cbc380676691b99c82b79b89c6f83e3aa2727a868642604051613a8e9392919061696c565b60405180910390a360019150509392505050565b60008073ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff1614151515613adf57600080fd5b6000600660008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000858152602001908152602001600020549050600080601060008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600087815260200190815260200160002054905060008190505b8381111515613bd857613bc9613bba6001613bac8b8b8b615d13565b615d8990919063ffffffff16565b84615c7290919063ffffffff16565b92508080600101915050613b90565b50613c2a826000808a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b6000808973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508673ffffffffffffffffffffffffffffffffffffffff16600c547f88693d1b37969a55dc388e433b081b6f04c84519870ec4976c2326077b95007c888542604051613cb99392919061696c565b60405180910390a3600193505050509392505050565b600080600f60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008481526020019081526020016000206000015490508091505092915050565b600081565b6000826008548111151515613d4b57600080fd5b600081111515613d5a57600080fd5b600660008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000858152602001908152602001600020548311151515613db957600080fd5b601460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515613e1557600080fd5b613e20853385610f86565b506000601160008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000868152602001908152602001600020549050613e8b84600154615cc990919063ffffffff16565b600181905550613ee2846000808973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615cc990919063ffffffff16565b6000808873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550613f8784601160008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600088815260200190815260200160002054615cc990919063ffffffff16565b601160008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000878152602001908152602001600020819055506000601160008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600087815260200190815260200160002054905061409385600660008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600089815260200190815260200160002054615cc990919063ffffffff16565b600660008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008881526020019081526020016000208190555060006001830390505b818110151561413f57600a8181548110151561410857fe5b90600052602060002090600302016000808201600090556001820160009055600282016000905550508080600190039150506140f0565b5060008090505b600b8054905081101561424f578773ffffffffffffffffffffffffffffffffffffffff16600b8281548110151561417957fe5b906000526020600020906002020160000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff161480156141ed575086600b828154811015156141d957fe5b906000526020600020906002020160010154145b1561424257600b8181548110151561420157fe5b9060005260206000209060020201600080820160006101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055600182016000905550505b8080600101915050614146565b50600073ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef876040516142ae9190616928565b60405180910390a37f070d0480bd92aa8655bafa329c42090f2ffad2beb8865d2a26c36a5a163fa6b78787876040516142e993929190616774565b60405180910390a1600193505050509392505050565b600a8181548110151561430e57fe5b90600052602060002090600302016000915090508060000154908060010154908060020154905083565b6011602052816000526040600020602052806000526040600020600091509150505481565b60008073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415151561439a57600080fd5b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205482111515156143e757600080fd5b614438826000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615cc990919063ffffffff16565b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506144cb826000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b6000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8460405161456a9190616928565b60405180910390a36001905092915050565b60008073ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff16141515156145b957600080fd5b600015156004876040518082805190602001908083835b6020831015156145f557805182526020820191506020810190506020830392506145d0565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060009054906101000a900460ff16151514151561464457600080fd5b60006146773063a45f71ff7c0100000000000000000000000000000000000000000000000000000000028888888861530c565b905060006146858289611756565b9050600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16141515156146c357600080fd5b6147166001600560008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b8414151561472357600080fd5b6000808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054614803866147f589600260008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008d73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b615c7290919063ffffffff16565b1115151561481057600080fd5b83600560008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555060016004896040518082805190602001908083835b60208310151561488e5780518252602082019150602081019050602083039250614869565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060006101000a81548160ff02191690831515021790555061496786600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b600260008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550614a38856000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615cc990919063ffffffff16565b6000808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550614acb856000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b6000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508673ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054604051614be69190616928565b60405180910390a33373ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef87604051614c4b9190616928565b60405180910390a33373ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff167f43a220267705e74ee2ceafd46afc841850db6f85a662189a7def697bbdd90ffb600260008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205489604051614d45929190616943565b60405180910390a460019250505095945050505050565b6006602052816000526040600020602052806000526040600020600091509150505481565b600f602052816000526040600020602052806000526040600020600091509150508060000154908060010154908060020154905083565b60008060085490508091505090565b600b81815481101515614dd657fe5b90600052602060002090600202016000915090508060000160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010154905082565b6010602052816000526040600020602052806000526040600020600091509150505481565b60008073ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff1614151515614e7c57600080fd5b6000614e918385615cc990919063ffffffff16565b9050614f0984601360008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008881526020019081526020016000206000600c54815260200190815260200160002054615cc990919063ffffffff16565b601360008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008781526020019081526020016000206000600c54815260200190815260200160002081905550614fd381600660008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600088815260200190815260200160002054615c7290919063ffffffff16565b600660008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600087815260200190815260200160002081905550600c548673ffffffffffffffffffffffffffffffffffffffff167fd4a162c374072910f5390c5358cbc380676691b99c82b79b89c6f83e3aa2727a8787426040516150749392919061696c565b60405180910390a36001915050949350505050565b600061511a82600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546040516152739190616928565b60405180910390a36001905092915050565b6000600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b6000868686868686604051602001808773ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166c01000000000000000000000000028152601401867bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19167bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191681526004018573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166c0100000000000000000000000002815260140184815260200183815260200182815260200196505050505050506040516020818303038152906040528051906020012090509695505050505050565b600085600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff161415151561545c57600080fd5b601460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156154b857600080fd5b8560085481111515156154ca57600080fd5b6000811115156154d957600080fd5b60076000600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000600c54815260200190815260200160002054841115151561555c57600080fd5b60006001850290506155b5816000808c73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054615c7290919063ffffffff16565b6000808b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055506155ff615f09565b878160000181815250508681602001818152505088816040018181525050615625615f2b565b8a816000019073ffffffffffffffffffffffffffffffffffffffff16908173ffffffffffffffffffffffffffffffffffffffff168152505089816020018181525050600b819080600181540180825580915050906001820390600052602060002090600202016000909192909190915060008201518160000160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506020820151816001015550505081600f60008d73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008c81526020019081526020016000206000820151816000015560208201518160010155604082015181600201559050506000600154905080601060008e73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008d81526020019081526020016000208190555060008190505b84820181101561582357600a849080600181540180825580915050906001820390600052602060002090600302016000909192909190915060008201518160000155602082015181600101556040820151816002015550505080806001019150506157bd565b506158378482615c7290919063ffffffff16565b601160008e73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008d8152602001908152602001600020819055506158a084600154615c7290919063ffffffff16565b60018190555061590984600660008f73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008e815260200190815260200160002054615c7290919063ffffffff16565b600660008e73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008d8152602001908152602001600020819055506159e48460076000600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000600c54815260200190815260200160002054615cc990919063ffffffff16565b60076000600960009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000600c548152602001908152602001600020819055507f8046176a8e4b943ac80fe153ace3eea3ac3fdfd2037e9040d0550a2d4655b36a8c8c8c8c8c89604051615a95969594939291906167ab565b60405180910390a16001965050505050505095945050505050565b600080600f60008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008481526020019081526020016000206001015490508091505092915050565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515615b6f57600080fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff16141515615c635780600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f31678cf613062d05b4ca0df3573ed11e02e662ea50efc380fbadefaf408add5f60405160405180910390a35b50565b600d5481565b600c5481565b6000808284019050838110151515615cbf576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401615cb6906168c8565b60405180910390fd5b8091505092915050565b6000615d0b83836040805190810160405280601e81526020017f536166654d6174683a207375627472616374696f6e206f766572666c6f770000815250615dd3565b905092915050565b600080615d7c83600f60008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600087815260200190815260200160002060000154615e3090919063ffffffff16565b9050809150509392505050565b6000615dcb83836040805190810160405280601a81526020017f536166654d6174683a206469766973696f6e206279207a65726f000000000000815250615ea4565b905092915050565b60008383111582901515615e1d576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401615e149190616886565b60405180910390fd5b5060008385039050809150509392505050565b600080831415615e435760009050615e9e565b60008284029050828482811515615e5657fe5b04141515615e99576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401615e90906168e8565b60405180910390fd5b809150505b92915050565b600080831182901515615eed576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401615ee49190616886565b60405180910390fd5b5060008385811515615efb57fe5b049050809150509392505050565b6060604051908101604052806000815260200160008152602001600081525090565b6040805190810160405280600073ffffffffffffffffffffffffffffffffffffffff168152602001600081525090565b6000615f678235616ac3565b905092915050565b6000615f7b8235616ad5565b905092915050565b6000615f8f8235616adf565b905092915050565b600082601f8301121515615faa57600080fd5b8135615fbd615fb8826169eb565b6169be565b91508082526020830160208301858383011115615fd957600080fd5b615fe4838284616b15565b50505092915050565b6000615ff98235616b0b565b905092915050565b60006020828403121561601357600080fd5b600061602184828501615f5b565b91505092915050565b6000806040838503121561603d57600080fd5b600061604b85828601615f5b565b925050602061605c85828601615f5b565b9150509250929050565b60008060006060848603121561607b57600080fd5b600061608986828701615f5b565b935050602061609a86828701615f5b565b92505060406160ab86828701615fed565b9150509250925092565b600080604083850312156160c857600080fd5b60006160d685828601615f5b565b92505060206160e785828601615f6f565b9150509250929050565b60008060008060008060c0878903121561610a57600080fd5b600061611889828a01615f5b565b965050602061612989828a01615f83565b955050604061613a89828a01615f5b565b945050606061614b89828a01615fed565b935050608061615c89828a01615fed565b92505060a061616d89828a01615fed565b9150509295509295509295565b6000806040838503121561618d57600080fd5b600061619b85828601615f5b565b92505060206161ac85828601615fed565b9150509250929050565b6000806000606084860312156161cb57600080fd5b60006161d986828701615f5b565b93505060206161ea86828701615fed565b92505060406161fb86828701615f6f565b9150509250925092565b60008060006060848603121561621a57600080fd5b600061622886828701615f5b565b935050602061623986828701615fed565b925050604061624a86828701615fed565b9150509250925092565b6000806000806080858703121561626a57600080fd5b600061627887828801615f5b565b945050602061628987828801615fed565b935050604061629a87828801615fed565b92505060606162ab87828801615fed565b91505092959194509250565b600080600080600060a086880312156162cf57600080fd5b60006162dd88828901615f5b565b95505060206162ee88828901615fed565b94505060406162ff88828901615fed565b935050606061631088828901615fed565b925050608061632188828901615fed565b9150509295509295909350565b6000806040838503121561634157600080fd5b600061634f85828601615f6f565b925050602083013567ffffffffffffffff81111561636c57600080fd5b61637885828601615f97565b9150509250929050565b600080600080600060a0868803121561639a57600080fd5b600086013567ffffffffffffffff8111156163b457600080fd5b6163c088828901615f97565b95505060206163d188828901615f5b565b94505060406163e288828901615fed565b93505060606163f388828901615fed565b925050608061640488828901615fed565b9150509295509295909350565b60006020828403121561642357600080fd5b600061643184828501615fed565b91505092915050565b61644381616a64565b82525050565b61645281616a52565b82525050565b600061646382616a24565b80845260208401935061647583616a17565b60005b828110156164a75761648b86835161668b565b61649482616a45565b9150606086019550600181019050616478565b50849250505092915050565b6164bc81616a76565b82525050565b6164cb81616a82565b82525050565b60006164dc82616a3a565b8084526164f0816020860160208601616b24565b6164f981616b57565b602085010191505092915050565b600061651282616a2f565b808452616526816020860160208601616b24565b61652f81616b57565b602085010191505092915050565b6000602282527f45524332303a20617070726f766520746f20746865207a65726f20616464726560208301527f73730000000000000000000000000000000000000000000000000000000000006040830152606082019050919050565b6000601b82527f536166654d6174683a206164646974696f6e206f766572666c6f7700000000006020830152604082019050919050565b6000602182527f536166654d6174683a206d756c7469706c69636174696f6e206f766572666c6f60208301527f77000000000000000000000000000000000000000000000000000000000000006040830152606082019050919050565b6000602482527f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460208301527f72657373000000000000000000000000000000000000000000000000000000006040830152606082019050919050565b6060820160008201516166a160008501826166cd565b5060208201516166b460208501826166cd565b5060408201516166c760408501826166cd565b50505050565b6166d681616aac565b82525050565b6166e581616ab6565b82525050565b60006020820190506167006000830184616449565b92915050565b600060808201905061671b600083018761643a565b6167286020830186616449565b6167356040830185616449565b61674260608301846166cd565b95945050505050565b60006040820190506167606000830185616449565b61676d60208301846166cd565b9392505050565b60006060820190506167896000830186616449565b61679660208301856166cd565b6167a360408301846166cd565b949350505050565b600060c0820190506167c06000830189616449565b6167cd60208301886166cd565b6167da60408301876166cd565b6167e760608301866166cd565b6167f460808301856166cd565b61680160a08301846166cd565b979650505050505050565b600060208201905081810360008301526168268184616458565b905092915050565b600060208201905061684360008301846164b3565b92915050565b600060208201905061685e60008301846164c2565b92915050565b6000602082019050818103600083015261687e8184616507565b905092915050565b600060208201905081810360008301526168a081846164d1565b905092915050565b600060208201905081810360008301526168c18161653d565b9050919050565b600060208201905081810360008301526168e18161659a565b9050919050565b60006020820190508181036000830152616901816165d1565b9050919050565b600060208201905081810360008301526169218161662e565b9050919050565b600060208201905061693d60008301846166cd565b92915050565b600060408201905061695860008301856166cd565b61696560208301846166cd565b9392505050565b600060608201905061698160008301866166cd565b61698e60208301856166cd565b61699b60408301846166cd565b949350505050565b60006020820190506169b860008301846166dc565b92915050565b6000604051905081810181811067ffffffffffffffff821117156169e157600080fd5b8060405250919050565b600067ffffffffffffffff821115616a0257600080fd5b601f19601f8301169050602081019050919050565b6000602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b6000616a5d82616a8c565b9050919050565b6000616a6f82616a8c565b9050919050565b60008115159050919050565b6000819050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600060ff82169050919050565b6000616ace82616a8c565b9050919050565b6000819050919050565b60007fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b6000819050919050565b82818337600083830152505050565b60005b83811015616b42578082015181840152602081019050616b27565b83811115616b51576000848401525b50505050565b6000601f19601f830116905091905056fea265627a7a723058204c3bf13220036e4d9f2a22e1c011fd7e89a17d9033171b41c530f129a8d6748c6c6578706572696d656e74616cf50037";
        var platform_for_tranche = "0xa046071D5e04d7a99E39631b84B3fE1cAc1B6Ebf";
        var platform_priv_key_for_tranche = Buffer.from("28f85880570e20f88edff0e812c3966f6583b2ba1f1de5f3f5f73f7e16e7eec5", "hex");
        var borrower = req.session.user_wallet_address;
        var total_class = 3;
        var maxDemand = req.session.use_amount;
        var demandID = credit_ID;
        var deploy_tranche_count=web3.eth.getTransactionCount(platform_for_tranche);
        var deploy_tranche_gasPrice=web3.toWei(10,'gwei');
        var deploy_tranche_gasLimit=3000000;
        var tranche_contract = new web3.eth.Contract(abi).new(borrower,demandID,total_class,maxDemand,
            {
             "from":platform_for_tranche,
             "nonce":web3.toHex(deploy_tranche_count),
             "gasPrice":deploy_tranche_gasPrice,
             "gasLimit":deploy_tranche_gasLimit,
             "value":"0x00",
             "data": bytecode,
             "chainId":0x04
            });
        var deploy_tx = new Tx(tranche_contract, { chain: 'rinkeby' });
        deploy_tx.sign(platform_priv_key_for_tranche);
        var serializedTx_deploy = deploy_tx.serialize();
        var deployhash = web3.eth.sendRawTransaction('0x' + serializedTx_deploy.toString('hex'));
        console.log("deploy_hash:", deployhash)
        setTimeout(function(){
            var receipt = web3.eth.getTransactionReceipt(deployhash);
            var deploy_address = receipt.contractAddress;
            var pool = req.connection;
            const onTime = () => {
                const date = new Date();
                const mm = date.getMonth() + 1;
                const dd = date.getDate();
                return [date.getFullYear(), "-" +
                    (mm > 9 ? '' : '0') + mm, "-" +
                    (dd > 9 ? '' : '0') + dd
                ].join('');
            }
            var create_date = onTime();
            var rand = ('0x' + crypto.randomBytes(6).toString('hex'))
            console.log(rand)
            console.log("creditID_input", credit_ID)
            pool.getConnection(function (err, connection) {
                connection.query('INSERT INTO funding_requirement(requirementID,rand,creditID,borrower,borrower_id,funding_need,strategyID,credit_type,create_date,rate_times,match_status,now_matched_amount,now_matched_percent,deploy_contract) VALUES(?,?,?,?,?,?,?,?,?,?,?,0,0,?)', [requirementID, rand, credit_ID, req.session.user_wallet_address, req.session.user_id, use_amount, strategy_ID, 'Margin', create_date, rate, 'false', deploy_address], function (err, rows) {
                    if (err) {
                        res.render('error', {
                            message: err.message,
                            error: err
                        });
                        console.log(err);
                    } else {
                        console.log('Insert Success!')
                    }
                })

                connection.query('SELECT * FROM stocks WHERE stockid = ?', [strategy_ID], function (err, rows) {
                    if (err) {
                        res.render('error', {
                            message: err.message,
                            error: err
                        });
                    }
                    else {
                        var com_name = rows[0].nickname;
                        console.log(com_name)
                        connection.query('INSERT INTO transaction(randID,idcode_commodity,investment_amount,buyer_id,com_name,buy_price,buy_role,buy_or_sell,type,requirement_id,collateral_status) VALUES(?,?,?,?,?,?,?,?,?,?,?)', [rand, strategy_ID, use_amount, req.session.user_id, com_name, req.session.buy_price, 'user', 'buy', 'crypto', requirementID, 'notused'], function (err, rows) {
                            if (err) {
                                res.render('error', {
                                    message: err.message,
                                    error: err

                                });
                                console.log(err);
                            } else {
                                console.log('Insert into transaction success!')
                            }
                        })
                    }
                    res.render('invest/margin_transaction/use_margin_success', {
                        session: req.session.user_id,
                        requirementID: requirementID,
                        rand: rand,
                        user: req.session.user_id,
                        address: req.session.walletaddress,
                    });
                })
                connection.release()
            })

        },30000);
        //var receipt = web3.eth.getTransactionReceipt(deployhash);
        //var deploy_address=receipt.contractAddress;
        /*
        var pool = req.connection;
        pool.getConnection(function (err, connection) {
            connection.query('INSERT INTO funding_requirement(requirementID,rand,creditID,borrower,borrower_id,funding_need,strategyID,credit_type,create_date,rate_times,match_status,now_matched_amount,now_matched_percent,deploy_contract) VALUES(?,?,?,?,?,?,?,?,?,?,?,0,0,?)', [requirementID, rand, credit_ID, req.session.user_wallet_address, req.session.user_id, use_amount, strategy_ID, 'Margin',  create_date, rate, 'false',deploy_address], function (err, rows) {
                if (err) {
                    res.render('error', {
                        message: err.message,
                        error: err
                    });
                    console.log(err);
                } else {
                    console.log('Insert Success!')
                }
            })
       
            connection.query('SELECT * FROM stocks WHERE stockid = ?', [strategy_ID], function (err, rows) {
                if (err) {
                    res.render('error', {
                        message: err.message,
                        error: err
                    });
                }
                else {
                    var com_name = rows[0].nickname;
                    console.log(com_name)
                    connection.query('INSERT INTO transaction(randID,idcode_commodity,investment_amount,buyer_id,com_name,buy_price,buy_role,buy_or_sell,type,requirement_id,collateral_status) VALUES(?,?,?,?,?,?,?,?,?,?,?)', [rand, strategy_ID, use_amount, req.session.user_id, com_name, req.session.buy_price, 'user', 'buy', 'crypto', requirementID,'notused'], function (err, rows) {
                        if (err) {
                            res.render('error', {
                                message: err.message,
                                error: err

                            });
                            console.log(err);
                        } else {
                            console.log('Insert into transaction success!')
                        }
                    })
                }
            })
            connection.release()
        })
*/
})

module.exports = router;